name: pr_review_notice

on:
  pull_request_target:
    types: [opened]

# Needed for commenting on PRs reliably
permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  comment_review_notice:
    runs-on: ubuntu-latest
    steps:
      - name: Comment review notice (non-maintainers only)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;

            const pr = context.payload.pull_request;
            const pr_number = pr.number;
            const pr_author = pr.user.login;

            // Maintainers list (case-insensitive)
            const maintainers = [
              "ShahzaibAhmad05",
              "d-khalid",
            ].map(u => u.toLowerCase());

            const isMaintainer = maintainers.includes(pr_author.toLowerCase());
            if (isMaintainer) {
              core.info(`Skipping: ${pr_author} is a maintainer.`);
              return;
            }

            const notice =
              "Thank you for the pull request! âœ…\n\n" +
              "A maintainer will review this soon. Please be patient while we take a look. ðŸ™Œ";

            // Avoid duplicate notices from the bot
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pr_number,
              per_page: 100,
            });

            const alreadyCommented = comments.some(c =>
              c.user?.type === "Bot" &&
              (c.body || "").includes("Thank you for the pull request! âœ…")
            );

            if (alreadyCommented) {
              core.info("Notice already posted. Skipping duplicate.");
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: notice,
            });

            core.info("Posted review notice comment.");
